<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

		<style>
.table-sticky-head {
	overflow: auto;
	height: 600px;
}

.table-sticky-head tr.first th {
	position: sticky;
	top: 0;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}

.table-sticky-head tr.second th {
	position: sticky;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}
		</style>

		<title>METROPOLIS2 Simulation Report</title>
	</head>
	<body>
		<h1>METROPOLIS2 Simulation Report</h1>

		<h2>Convergence</h2>

		<div class="table-responsive table-sticky-head">
			<table class="table table-striped table-bordered table-hover table-sm">
				<thead class="thead-light">
					<tr class="first">
						<th scope="col" rowspan="2" class="text-center">Iteration</th>
						<th scope="col" rowspan="2" class="text-center">Agent-level expected utility</th>
						<th scope="col" colspan="2" class="text-center">No-trip alternatives</th>
						<th scope="col" colspan="8" class="text-center">Alternative-level</th>
						<th scope="col" colspan="22" class="text-center">Road-trips level</th>
						<th scope="col" colspan="10" class="text-center">Virtual-trip level</th>
						<th scope="col" colspan="2" class="text-center">Road Network</th>
					</tr>
					<tr class="second">
						<!-- CONSTANT UTILITY -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- TRIPS -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected utility</th>
						<th scope="col" class="text-center">Mean departure-time shift</th>
						<th scope="col" class="text-center">Departure time RMSE</th>
						<!-- ROAD LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ road trip)</th>
						<th scope="col" class="text-center"># Alternatives (only road trips)</th>
						<th scope="col" class="text-center">Mean # road trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean road time</th>
						<th scope="col" class="text-center">Mean in-bottleneck time</th>
						<th scope="col" class="text-center">Mean out-bottleneck time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean route free-flow travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean route congestion</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean route length (m)</th>
						<th scope="col" class="text-center">Mean edge count</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected travel time</th>
						<th scope="col" class="text-center">Mean expected travel time difference (rel.)</th>
						<th scope="col" class="text-center">Mean expected travel time difference (abs.)</th>
						<th scope="col" class="text-center">Expected travel time difference RMSE</th>
						<th scope="col" class="text-center">Mean length difference (m)</th>
						<!-- VIRTUAL LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ virtual trip)</th>
						<th scope="col" class="text-center"># Alternatives (only virtual trips)</th>
						<th scope="col" class="text-center">Mean # virtual trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- ROAD NETWORK -->
						<th scope="col" class="text-center">Simulated road-network conditions RMSE</th>
						<th scope="col" class="text-center">Expected road-network conditions RMSE</th>
					</tr>
				</thead>
				<tbody><tr>
						<td scope="row" class="text-center">1</td>
						<td class="text-center">0.0000</td><td class="text-center">0</td>
								<td class="text-center">N/A</td><!-- TRIPS -->
								<td class="text-center">480185</td>
								<td class="text-center">13:27:49</td>
								<td class="text-center">15:46:23</td>
								<td class="text-center">00:33:10</td>
								<td class="text-center">0.0000</td>
								<td class="text-center">0.0000</td><td class="text-center">N/A</td><td class="text-center">N/A</td><!-- ROAD LEGS --><td class="text-center">480185</td>
									<td class="text-center">480185</td>
									<td class="text-center">480185</td>
									<td class="text-center">1.0000</td>
									<td class="text-center">13:27:49</td>
									<td class="text-center">14:00:59</td>
									<td class="text-center">00:22:03</td>
									<td class="text-center">00:11:07</td>
									<td class="text-center">00:00:00</td>
									<td class="text-center">00:33:10</td>
									<td class="text-center">00:22:03</td>
									<td class="text-center">00:22:03</td>
									<td class="text-center">0.5108</td>
									<td class="text-center">0.5108</td>
									<td class="text-center">16459</td>
									<td class="text-center">70.01</td>
									<td class="text-center">0.0000</td>
									<td class="text-center">00:22:03</td>
									<td class="text-center">0.5108</td>
									<td class="text-center">00:11:07</td>
									<td class="text-center">00:27:13</td><td class="text-center">N/A</td><!-- VIRTUAL LEGS --><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">N/A</td><td class="text-center">00:00:20</td><td class="text-center">00:00:20</td></tr></tbody>
			</table>
		</div>

		<ul class="nav nav-tabs">
			<li class="nav-item">
				<a class="nav-link active" id="surplus-tab" data-toggle="tab" href="#surplus" role="tab">Agent Expected Utility (Surplus)</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="mean_departure_time-tab" data-toggle="tab" href="#mean_departure_time" role="tab">Mean Departure Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="dt_rmse-tab" data-toggle="tab" href="#dt_rmse" role="tab">Departure Time RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="travel_time-tab" data-toggle="tab" href="#travel_time" role="tab">Mean Travel Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="expect_rmse-tab" data-toggle="tab" href="#expect_rmse" role="tab">Expected Travel Time Diff RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="sim_rn_cond_rmse-tab" data-toggle="tab" href="#sim_rn_cond_rmse" role="tab">Simulated Road Network Conditions RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="exp_rn_cond_rmse-tab" data-toggle="tab" href="#exp_rn_cond_rmse" role="tab">Expected Road Network Conditions RMSE</a>
			</li>
		</ul>

		<div class="tab-content" id="convergenceCharts">
			<div class="tab-pane fade show active" id="surplus" role="tabpanel">
				<div id="surplusChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="mean_departure_time" role="tabpanel">
				<div id="meanDepartureTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="dt_rmse" role="tabpanel">
				<div id="dtRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="travel_time" role="tabpanel">
				<div id="travelTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="expect_rmse" role="tabpanel">
				<div id="expectRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="sim_rn_cond_rmse" role="tabpanel">
				<div id="simRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="exp_rn_cond_rmse" role="tabpanel">
				<div id="expRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
		</div>

		<h2>Last Iteration</h2>

		<div id="roadDepartureTimeHist" style="height: 600px; width: 1000px"></div>

		<div id="roadArrivalTimeHist" style="height: 600px; width: 1000px"></div>

		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>

		<script>
			function secondsToString(seconds) {
				var date = new Date(0);
				date.setSeconds(seconds);
				var isoString = date.toISOString();
				return isoString;
			}

			const iters = [1,];
			const surplus = [0,];
			const mean_departure_time = [secondsToString(48468.883730228976),];
			const dt_rmse = ["",];
			const travel_time = [secondsToString(1989.8616711236043),];
			const expect_rmse = [secondsToString(1632.6990639795983),];
			const sim_rn_cond_rmse = [secondsToString(20.028984117472234),];
			const exp_rn_cond_rmse = [secondsToString(20.028984117472234),];

			function linspace(start, stop, num) {
				const step = (stop - start) / (num - 1);
				return Array.from({length: num}, (_, i) => secondsToString(start + step * i));
			}

			const departure_time_bars = [29,32,23,34,36,32,35,32,41,53,53,70,62,67,64,70,103,279,290,353,429,807,1240,1713,2153,3161,4157,4584,5184,5928,6097,7754,8688,9569,8716,8512,8110,8010,8245,7440,7429,6605,6708,6453,6561,6146,6148,6196,6057,6253,6374,6628,6562,6667,6626,6623,6491,6805,7346,7785,7978,8332,9085,9110,9572,9602,10795,10716,10403,9906,10144,9951,9306,9025,8879,9198,8373,7858,7262,6888,6147,5482,4913,4705,4121,3656,3345,3173,2949,2456,2106,1802,1507,1307,956,800,679,507,384,284,259,215,457,107,94,65,72,63,44,50,40,30,33,31,26,25,16,27,23,16,13,10,19,18,16,9,11,16,];
			const dt_start =0;
			const dt_end =107863;
			const dt_interval = (dt_end - dt_start) / departure_time_bars.length;
			const road_departure_times = linspace(
				dt_start + dt_interval / 2,
				dt_end - dt_interval / 2,
				departure_time_bars.length,
			);

			const arrival_time_bars = [3,9,5,11,21,34,34,26,36,44,53,51,71,63,79,86,130,180,217,315,509,822,1602,2201,3072,3768,4434,5458,6777,8160,9537,10126,9714,9686,9735,9836,9287,8313,8200,7954,7694,7172,7033,6948,7112,7218,7374,7198,7036,7255,7224,7243,7294,7722,8035,8404,8966,9318,9582,10052,10723,10719,10685,10531,10631,10337,10286,10225,10135,9885,9149,8594,7898,7372,6727,6225,5532,5153,4797,4348,3870,3277,2834,2411,2144,1710,1487,1145,908,712,575,480,426,412,208,150,127,82,89,78,54,51,52,40,42,37,34,27,26,30,27,19,16,21,11,19,12,12,8,13,12,3,1,1,0,0,0,1,];
			const at_start =0;
			const at_end =120307;
			const at_interval = (at_end - at_start) / arrival_time_bars.length;
			const road_arrival_times = linspace(
				at_start + at_interval / 2,
				at_end - at_interval / 2,
				arrival_time_bars.length,
			);

			$(document).ready(function() {
							var firstHeight = $('.first').height();
							$("thead tr.second th").css("top", firstHeight)
						});

			var surplus_trace = {
							x: iters,
							y: surplus,
							type: 'scatter'
						};
			Plotly.newPlot('surplusChart', [surplus_trace]);

			if (mean_departure_time.length > 0) {
				var mean_departure_time_trace = {
					x: iters,
					y: mean_departure_time,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('meanDepartureTimeChart', [mean_departure_time_trace], layout);
			}

			if (dt_rmse.length > 0) {
				var dt_rmse_trace = {
								x: iters,
								y: dt_rmse,
								type: 'scatter'
							};
				var layout = {
								yaxis: {
												tickformat: "%H:%M:%S"
											}
							};
				Plotly.newPlot('dtRmseChart', [dt_rmse_trace], layout);
			}

			if (travel_time.length) {
				var travel_time_trace = {
					x: iters,
					y: travel_time,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('travelTimeChart', [travel_time_trace], layout);
			}

			if (expect_rmse.length > 0) {
				var expect_rmse_trace = {
								x: iters,
								y: expect_rmse,
								type: 'scatter'
							};
				var layout = {
								yaxis: {
												tickformat: "%H:%M:%S"
											}
							};
				Plotly.newPlot('expectRmseChart', [expect_rmse_trace], layout);
			}

			if (sim_rn_cond_rmse.length > 0) {
				var sim_rn_cond_rmse_trace = {
					x: iters,
					y: sim_rn_cond_rmse,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('simRnCondRmseChart', [sim_rn_cond_rmse_trace], layout);
			}

			if (exp_rn_cond_rmse.length > 0) {
				var exp_rn_cond_rmse_trace = {
					x: iters,
					y: exp_rn_cond_rmse,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('expRnCondRmseChart', [exp_rn_cond_rmse_trace], layout);
			}

			var road_departure_times_trace = {
				x: road_departure_times,
				y: departure_time_bars,
				line_shape: "hvh",
			};
			var layout = {
				title: "Departure times distribution",
				xaxis: {
					tickformat: "%H:%M:%S"
				}
			};
			Plotly.newPlot('roadDepartureTimeHist', [road_departure_times_trace], layout);

			var road_arrival_times_trace = {
				x: road_arrival_times,
				y: arrival_time_bars,
				line_shape: "hvh",
			};
			var layout = {
				title: "Arrival times distribution",
				xaxis: {
					tickformat: "%H:%M:%S"
				}
			};
			Plotly.newPlot('roadArrivalTimeHist', [road_arrival_times_trace], layout);
		</script>
	</body>
</html>