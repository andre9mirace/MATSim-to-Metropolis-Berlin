<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

		<style>
.table-sticky-head {
	overflow: auto;
	height: 600px;
}

.table-sticky-head tr.first th {
	position: sticky;
	top: 0;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}

.table-sticky-head tr.second th {
	position: sticky;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}
		</style>

		<title>METROPOLIS2 Simulation Report</title>
	</head>
	<body>
		<h1>METROPOLIS2 Simulation Report</h1>

		<h2>Convergence</h2>

		<div class="table-responsive table-sticky-head">
			<table class="table table-striped table-bordered table-hover table-sm">
				<thead class="thead-light">
					<tr class="first">
						<th scope="col" rowspan="2" class="text-center">Iteration</th>
						<th scope="col" rowspan="2" class="text-center">Agent-level expected utility</th>
						<th scope="col" colspan="2" class="text-center">No-trip alternatives</th>
						<th scope="col" colspan="8" class="text-center">Alternative-level</th>
						<th scope="col" colspan="22" class="text-center">Road-trips level</th>
						<th scope="col" colspan="10" class="text-center">Virtual-trip level</th>
						<th scope="col" colspan="2" class="text-center">Road Network</th>
					</tr>
					<tr class="second">
						<!-- CONSTANT UTILITY -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- TRIPS -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected utility</th>
						<th scope="col" class="text-center">Mean departure-time shift</th>
						<th scope="col" class="text-center">Departure time RMSE</th>
						<!-- ROAD LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ road trip)</th>
						<th scope="col" class="text-center"># Alternatives (only road trips)</th>
						<th scope="col" class="text-center">Mean # road trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean road time</th>
						<th scope="col" class="text-center">Mean in-bottleneck time</th>
						<th scope="col" class="text-center">Mean out-bottleneck time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean route free-flow travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean route congestion</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean route length (m)</th>
						<th scope="col" class="text-center">Mean edge count</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected travel time</th>
						<th scope="col" class="text-center">Mean expected travel time difference (rel.)</th>
						<th scope="col" class="text-center">Mean expected travel time difference (abs.)</th>
						<th scope="col" class="text-center">Expected travel time difference RMSE</th>
						<th scope="col" class="text-center">Mean length difference (m)</th>
						<!-- VIRTUAL LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ virtual trip)</th>
						<th scope="col" class="text-center"># Alternatives (only virtual trips)</th>
						<th scope="col" class="text-center">Mean # virtual trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- ROAD NETWORK -->
						<th scope="col" class="text-center">Simulated road-network conditions RMSE</th>
						<th scope="col" class="text-center">Expected road-network conditions RMSE</th>
					</tr>
				</thead>
				<tbody><tr>
						<td scope="row" class="text-center">1</td>
						<td class="text-center">0.0000</td><td class="text-center">0</td>
								<td class="text-center">N/A</td><!-- TRIPS -->
								<td class="text-center">1091737</td>
								<td class="text-center">12:36:04</td>
								<td class="text-center">16:08:43</td>
								<td class="text-center">00:43:44</td>
								<td class="text-center">0.0000</td>
								<td class="text-center">0.0000</td><td class="text-center">N/A</td><td class="text-center">N/A</td><!-- ROAD LEGS --><td class="text-center">663060</td>
									<td class="text-center">369607</td>
									<td class="text-center">0</td>
									<td class="text-center">1.7940</td>
									<td class="text-center">13:46:08</td>
									<td class="text-center">14:16:49</td>
									<td class="text-center">00:21:56</td>
									<td class="text-center">00:08:41</td>
									<td class="text-center">00:00:05</td>
									<td class="text-center">00:30:42</td>
									<td class="text-center">00:21:56</td>
									<td class="text-center">00:21:56</td>
									<td class="text-center">0.4016</td>
									<td class="text-center">0.4016</td>
									<td class="text-center">16908</td>
									<td class="text-center">69.19</td>
									<td class="text-center">0.0000</td>
									<td class="text-center">00:21:56</td>
									<td class="text-center">0.4016</td>
									<td class="text-center">00:08:46</td>
									<td class="text-center">00:23:18</td><td class="text-center">N/A</td><!-- VIRTUAL LEGS --><td class="text-center">4328283</td>
									<td class="text-center">1091737</td>
									<td class="text-center">722130</td>
									<td class="text-center">3.9646</td>
									<td class="text-center">13:34:38</td>
									<td class="text-center">13:40:57</td>
									<td class="text-center">00:06:20</td>
									<td class="text-center">00:06:20</td>
									<td class="text-center">0.0000</td>
									<td class="text-center">0.0000</td><td class="text-center">00:00:26</td><td class="text-center">00:00:26</td></tr></tbody>
			</table>
		</div>

		<ul class="nav nav-tabs">
			<li class="nav-item">
				<a class="nav-link active" id="surplus-tab" data-toggle="tab" href="#surplus" role="tab">Agent Expected Utility (Surplus)</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="mean_departure_time-tab" data-toggle="tab" href="#mean_departure_time" role="tab">Mean Departure Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="dt_rmse-tab" data-toggle="tab" href="#dt_rmse" role="tab">Departure Time RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="travel_time-tab" data-toggle="tab" href="#travel_time" role="tab">Mean Travel Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="expect_rmse-tab" data-toggle="tab" href="#expect_rmse" role="tab">Expected Travel Time Diff RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="sim_rn_cond_rmse-tab" data-toggle="tab" href="#sim_rn_cond_rmse" role="tab">Simulated Road Network Conditions RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="exp_rn_cond_rmse-tab" data-toggle="tab" href="#exp_rn_cond_rmse" role="tab">Expected Road Network Conditions RMSE</a>
			</li>
		</ul>

		<div class="tab-content" id="convergenceCharts">
			<div class="tab-pane fade show active" id="surplus" role="tabpanel">
				<div id="surplusChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="mean_departure_time" role="tabpanel">
				<div id="meanDepartureTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="dt_rmse" role="tabpanel">
				<div id="dtRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="travel_time" role="tabpanel">
				<div id="travelTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="expect_rmse" role="tabpanel">
				<div id="expectRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="sim_rn_cond_rmse" role="tabpanel">
				<div id="simRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="exp_rn_cond_rmse" role="tabpanel">
				<div id="expRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
		</div>

		<h2>Last Iteration</h2>

		<div id="roadDepartureTimeHist" style="height: 600px; width: 1000px"></div>

		<div id="roadArrivalTimeHist" style="height: 600px; width: 1000px"></div>

		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>

		<script>
			function secondsToString(seconds) {
				var date = new Date(0);
				date.setSeconds(seconds);
				var isoString = date.toISOString();
				return isoString;
			}

			const iters = [1,];
			const surplus = [0,];
			const mean_departure_time = [secondsToString(45364.3651969293),];
			const dt_rmse = ["",];
			const travel_time = [secondsToString(2623.809633991762),];
			const expect_rmse = [secondsToString(1397.854895703293),];
			const sim_rn_cond_rmse = [secondsToString(26.3312496172742),];
			const exp_rn_cond_rmse = [secondsToString(26.3312496172742),];

			function linspace(start, stop, num) {
				const step = (stop - start) / (num - 1);
				return Array.from({length: num}, (_, i) => secondsToString(start + step * i));
			}

			const departure_time_bars = [210,115,221,119,151,291,210,309,245,296,712,851,1130,2592,4134,7090,9304,11469,13606,19186,21671,18220,17141,16860,15511,13817,13215,12773,12453,12439,12968,13416,13518,13847,13891,15313,17003,18895,20805,21958,24883,24144,23577,23216,21694,22001,20166,17833,16132,13714,11961,10297,8375,7814,6303,5132,4212,3196,2469,1793,1179,997,1273,490,377,332,250,185,169,146,124,109,89,81,77,73,61,35,33,29,28,13,10,7,7,6,5,0,2,2,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,];
			const dt_start =0;
			const dt_end =177728;
			const dt_interval = (dt_end - dt_start) / departure_time_bars.length;
			const road_departure_times = linspace(
				dt_start + dt_interval / 2,
				dt_end - dt_interval / 2,
				departure_time_bars.length,
			);

			const arrival_time_bars = [35,52,116,139,123,180,208,212,263,274,291,484,644,1114,2221,4506,6458,8576,11808,17545,21540,19444,18770,18756,16786,15212,14519,13452,12912,13019,13574,13308,13532,13887,14398,15163,16723,18972,20428,22300,24155,23564,23600,22922,22641,22339,20231,18140,16209,14186,12287,10684,9214,7883,6568,5622,4552,3746,2723,2021,1658,1733,972,657,478,387,323,256,193,153,154,137,130,88,87,70,71,62,40,40,39,28,21,17,7,3,9,3,3,3,2,1,2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,];
			const at_start =0;
			const at_end =181605;
			const at_interval = (at_end - at_start) / arrival_time_bars.length;
			const road_arrival_times = linspace(
				at_start + at_interval / 2,
				at_end - at_interval / 2,
				arrival_time_bars.length,
			);

			$(document).ready(function() {
							var firstHeight = $('.first').height();
							$("thead tr.second th").css("top", firstHeight)
						});

			var surplus_trace = {
							x: iters,
							y: surplus,
							type: 'scatter'
						};
			Plotly.newPlot('surplusChart', [surplus_trace]);

			if (mean_departure_time.length > 0) {
				var mean_departure_time_trace = {
					x: iters,
					y: mean_departure_time,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('meanDepartureTimeChart', [mean_departure_time_trace], layout);
			}

			if (dt_rmse.length > 0) {
				var dt_rmse_trace = {
								x: iters,
								y: dt_rmse,
								type: 'scatter'
							};
				var layout = {
								yaxis: {
												tickformat: "%H:%M:%S"
											}
							};
				Plotly.newPlot('dtRmseChart', [dt_rmse_trace], layout);
			}

			if (travel_time.length) {
				var travel_time_trace = {
					x: iters,
					y: travel_time,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('travelTimeChart', [travel_time_trace], layout);
			}

			if (expect_rmse.length > 0) {
				var expect_rmse_trace = {
								x: iters,
								y: expect_rmse,
								type: 'scatter'
							};
				var layout = {
								yaxis: {
												tickformat: "%H:%M:%S"
											}
							};
				Plotly.newPlot('expectRmseChart', [expect_rmse_trace], layout);
			}

			if (sim_rn_cond_rmse.length > 0) {
				var sim_rn_cond_rmse_trace = {
					x: iters,
					y: sim_rn_cond_rmse,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('simRnCondRmseChart', [sim_rn_cond_rmse_trace], layout);
			}

			if (exp_rn_cond_rmse.length > 0) {
				var exp_rn_cond_rmse_trace = {
					x: iters,
					y: exp_rn_cond_rmse,
					type: 'scatter'
				};
				var layout = {
					yaxis: {
						tickformat: "%H:%M:%S"
					}
				};
				Plotly.newPlot('expRnCondRmseChart', [exp_rn_cond_rmse_trace], layout);
			}

			var road_departure_times_trace = {
				x: road_departure_times,
				y: departure_time_bars,
				line_shape: "hvh",
			};
			var layout = {
				title: "Departure times distribution",
				xaxis: {
					tickformat: "%H:%M:%S"
				}
			};
			Plotly.newPlot('roadDepartureTimeHist', [road_departure_times_trace], layout);

			var road_arrival_times_trace = {
				x: road_arrival_times,
				y: arrival_time_bars,
				line_shape: "hvh",
			};
			var layout = {
				title: "Arrival times distribution",
				xaxis: {
					tickformat: "%H:%M:%S"
				}
			};
			Plotly.newPlot('roadArrivalTimeHist', [road_arrival_times_trace], layout);
		</script>
	</body>
</html>